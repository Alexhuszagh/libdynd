# branches to build
branches:
  only:
    - master
clone_depth: 1

# Do not build on tags (GitHub only)
skip_tags: true

matrix:
  fast_finish: true     # immediately finish build once one of the jobs fails.

environment:
  global:
    appveyor_token:
      secure: GvR4dCHoeYM712VDQYvSuNzFu+rZfo/zdns7xGlFPGOKfFvBmVCXTX6iuHmMpUeP
  matrix:
    - PYTHON_ARCH: "x86_64"
      platform: x64
    - PYTHON_ARCH: "x86"
      platform: Win32

configuration: Release

build_script:
  - ps: Start-FileDownload "https://repo.continuum.io/miniconda/Miniconda3-latest-Windows-$env:PYTHON_ARCH.exe" C:\Miniconda.exe; echo "Finished downloading miniconda"
  - cmd: C:\Miniconda.exe /S /D=C:\Py
  - SET PATH=C:\Py;C:\Py\Scripts;C:\Py\Library\bin;%PATH%
  - conda config --set always_yes yes
  - conda update conda
  - conda install conda-build
  # Install development version of conda build until the next release.
  # This ensures that, when the tests are run, libdynd.dll is on the path.
  - pip install git+git://github.com/conda/conda-build.git
  - ps: if(-not $env:APPVEYOR_PULL_REQUEST_NUMBER) { conda install anaconda-client }
  - conda-build conda.recipe

on_success:
  - ps: if(-not $env:APPVEYOR_PULL_REQUEST_NUMBER) { anaconda --token $env:appveyor_token upload (conda build --output conda.recipe) --user dynd --channel dev }
